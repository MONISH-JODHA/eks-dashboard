{% extends "base.html" %}

{% block title %}Cluster Details: {{ cluster.name }}{% endblock %}
{% block page_title %}Cluster Details{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Vis Network for workload graph -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />

    <style>
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .chart-widget-content {
            height: 300px;
            padding: 10px;
        }
        .widget-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .widget-header h2 {
            font-size: 1rem;
            font-weight: 500;
            margin: 0;
        }
        .error-message {
            color: #f87171;
            background-color: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        /* --- Styles for Workload Graph & Insights --- */
        #workload-graph-wrapper { position: relative; margin-bottom: 20px; }
        #workload-graph-container { display: flex; flex-direction: column; }
        #workload-graph { width: 100%; height: 600px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-color); }
        .graph-controls { display: flex; gap: 1rem; padding: 0.5rem 1rem; background-color: var(--surface-color); border: 1px solid var(--border-color); border-bottom: none; border-top-left-radius: 8px; border-top-right-radius: 8px; align-items: center; }
        .graph-controls input { padding: 0.5rem; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); width: 300px; }
        .graph-legend { display: flex; flex-wrap: wrap; gap: 0.5rem 1.5rem; align-items: center; margin-left: auto; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; }
        .legend-color.diamond { width: 10px; height: 10px; transform: rotate(45deg); }
        .legend-color.dot { border-radius: 50%; }
        .legend-color.triangle { width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 12px solid; background-color: transparent !important; }
        #graph-info-panel { position: absolute; top: 45px; right: 0; width: 350px; max-height: 550px; overflow-y: auto; background-color: rgba(15, 23, 42, 0.9); backdrop-filter: blur(5px); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; color: var(--text-primary); z-index: 10; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.3); font-size: 0.875rem; }
        #graph-info-panel h3 { margin-top: 0; font-size: 1.1rem; }
        #graph-info-panel .info-grid { display: grid; grid-template-columns: 100px 1fr; gap: 0.5rem 1rem; }
        #graph-info-panel .info-grid strong { color: var(--text-secondary); }
        #graph-info-panel .info-grid span { word-break: break-all; }
        #graph-info-panel hr { border-color: var(--border-color); margin: 1rem 0; }
        #graph-info-close { position: absolute; top: 10px; right: 10px; cursor: pointer; background: none; border: none; color: var(--text-secondary); }

        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .insight-card { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; }
        .insight-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .insight-card-title { font-weight: 600; font-size: 1rem; }
        .severity-badge { font-size: 0.75rem; font-weight: bold; padding: 4px 8px; border-radius: 12px; }
        .severity-high { background-color: #ef4444; color: white; }
        .severity-medium { background-color: #f97316; color: white; }
        .severity-low { background-color: #eab308; color: white; }
        .insight-card-body p { font-size: 0.875rem; color: var(--text-secondary); margin: 4px 0 12px; }
        .insight-card-body strong { color: var(--text-primary); }

        /* --- Cost & Time Machine Styles --- */
        .cost-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .what-if-form { display: flex; flex-direction: column; gap: 15px; }
        .what-if-form select, .what-if-form input { padding: 8px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); }
        #what-if-results { margin-top: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-color); display: none; }
        #what-if-results h4 { margin-top: 0; }
        .snapshot-list { list-style-type: none; padding: 0; }
        .snapshot-list li { background-color: var(--bg-color); border: 1px solid var(--border-color); padding: 10px 15px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .snapshot-diff-selector { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; }
        .diff-results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .diff-card { background-color: var(--bg-color); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; }
        .diff-card h4 { margin-top: 0; }
        .diff-added { color: #4ade80; }
        .diff-removed { color: #f87171; }
        .diff-changed { color: #facc15; }
        .diff-item { margin-bottom: 5px; font-size: 0.9rem; }
        .log-line.anomaly { color: #f97316; font-weight: 500; }
        .log-line.anomaly::before { content: "⚠️ "; }

    </style>
{% endblock %}

{% block content %}
    <a href="{{ url_for('read_dashboard') }}" class="back-link"><i data-feather="arrow-left"></i> Back to Dashboard</a>
    <h2 class="cluster-detail-title">{{ cluster.name or "Unknown Cluster" }}</h2>

    {% if cluster.errors %}
        <div class="error-message-box">
            <strong>Error fetching cluster details:</strong>
            <ul>{% for error in cluster.errors %}<li>{{ error }}</li>{% endfor %}</ul>
        </div>
    {% else %}
    <div class="tab-container">
        <div class="tab-nav">
            <button class="tab-link active" onclick="openTab(event, 'overview')"><i data-feather="layout"></i>Overview</button>
            <button class="tab-link" onclick="openTab(event, 'insights')"><i data-feather="bar-chart-2"></i>Analysis & Insights</button>
            <button class="tab-link" onclick="openTab(event, 'workloads')"><i data-feather="cpu"></i>Workloads</button>
            <button class="tab-link" onclick="openTab(event, 'compute')"><i data-feather="hard-drive"></i>Compute</button>
            <button class="tab-link" onclick="openTab(event, 'addons')"><i data-feather="box"></i>Add-ons</button>
            <button class="tab-link" onclick="openTab(event, 'observability')"><i data-feather="activity"></i>Observability</button>
            <button class="tab-link" onclick="openTab(event, 'cost')"><i data-feather="dollar-sign"></i>Cost Analysis</button>
            <button class="tab-link" onclick="openTab(event, 'timemachine')"><i data-feather="clock"></i>Time Machine</button>
            <button class="tab-link" onclick="openTab(event, 'logs')"><i data-feather="file-text"></i>Logs</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="widget">
                <div class="widget-header">
                    <h2>Cluster Summary</h2>
                    <button id="refreshBtn" class="action-button">
                        <i data-feather="refresh-cw"></i> Refresh Data
                    </button>
                </div>
                <div class="widget-content">
                    <div class="summary-grid">
                        <div><strong>ARN:</strong> <span class="text-muted code">{{ cluster.arn }}</span></div>
                        <div><strong>Status:</strong> <span class="status-badge status-{{ cluster.status.lower() if cluster.status else 'unknown' }}">{{ cluster.status }}</span></div>
                        <div><strong>Region:</strong> <span class="text-muted">{{ cluster.region }}</span></div>
                        <div><strong>Account ID:</strong> <span class="text-muted">{{ cluster.account_id }}</span></div>
                        <div><strong>K8s Version:</strong> <span class="text-muted">{{ cluster.version }}</span></div>
                        <div><strong>Platform Version:</strong> <span class="text-muted">{{ cluster.platformVersion }}</span></div>
                        <div><strong>Created At:</strong> <span class="text-muted">{{ cluster.createdAt.strftime('%Y-%m-%d') if cluster.createdAt else 'N/A' }}</span></div>
                        <div><strong>Est. Cost (30d):</strong> <span class="text-muted">{{ cluster.cost_30d or 'N/A' }}</span></div>
                        <div><strong>OIDC Provider:</strong> <span class="text-muted code">{{ cluster.oidc_provider_url or 'Not available' }}</span></div>
                    </div>
                </div>
            </div>
            <div class="widget">
                <div class="widget-header"><h2>Networking & Security</h2></div>
                <div class="widget-content">
                     <div class="summary-grid">
                        <div><strong>VPC ID:</strong> <span class="text-muted code">{{ cluster.networking.vpcId or 'N/A' }}</span></div>
                        <div><strong>Public Access:</strong> <span class="status-badge status-{{ 'active' if cluster.networking.endpointPublicAccess else 'deleting' }}">{{ 'Enabled' if cluster.networking.endpointPublicAccess else 'Disabled' }}</span></div>
                        <div><strong>Private Access:</strong> <span class="status-badge status-{{ 'active' if cluster.networking.endpointPrivateAccess else 'deleting' }}">{{ 'Enabled' if cluster.networking.endpointPrivateAccess else 'Disabled' }}</span></div>
                        <div><strong>Subnets:</strong> <div class="tags-container" style="margin-top: 5px;">{% for id in cluster.networking.subnetIds %}<span class="tag code">{{ id }}</span>{% else %}<span>N/A</span>{% endfor %}</div></div>
                    </div>
                </div>
            </div>
            {% if cluster.health_issues %}
            <div class="widget">
                <div class="widget-header"><h2>Health Issues</h2></div>
                <div class="widget-content">
                    {% for issue in cluster.health_issues %}
                    <div class="health-issue-box">
                        <strong class="code">{{ issue.code }}</strong>
                        <p>{{ issue.message }}</p>
                        <span>Resource IDs: {% for id in issue.resourceIds %}<span class="tag code">{{ id }}</span>{% endfor %}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Analysis & Insights Tab -->
        <div id="insights" class="tab-content">
            <div class="widget">
                <div class="widget-header"><h2>Cost Optimization Insights</h2></div>
                <div class="widget-content">
                    {% if cluster.cost_insights %}
                    <div class="insights-grid">
                        {% for insight in cluster.cost_insights %}
                        <div class="insight-card">
                            <div class="insight-card-header">
                                <span class="insight-card-title">{{ insight.title }}</span>
                                <span class="severity-badge severity-{{ insight.severity.lower() }}">{{ insight.severity }}</span>
                            </div>
                            <div class="insight-card-body">
                                <p>{{ insight.description }}</p>
                                <p><strong>Recommendation:</strong> {{ insight.recommendation }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted" style="text-align:center; padding: 20px 0;">No cost optimization opportunities found.</p>
                    {% endif %}
                </div>
            </div>
            <div class="widget">
                <div class="widget-header"><h2>Workload Anomaly Detection</h2></div>
                <div class="widget-content">
                    {% if cluster.analysis and cluster.analysis.anomalies %}
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>Pod</th><th>Namespace</th><th>Anomaly Type</th><th>Severity</th><th>Details</th></tr></thead>
                                <tbody>
                                {% for anom in cluster.analysis.anomalies %}
                                    <tr>
                                        <td>{{ anom.pod }}</td>
                                        <td>{{ anom.namespace }}</td>
                                        <td><span class="tag code">{{ anom.type }}</span></td>
                                        <td><span class="severity-badge severity-{{ anom.severity.lower() }}">{{ anom.severity }}</span></td>
                                        <td class="text-muted">{{ anom.details }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted" style="text-align: center; padding: 2rem;">No workload anomalies detected.</p>
                    {% endif %}
                </div>
            </div>
            <div class="widget">
                <div class="widget-header"><h2>Rightsizing Recommendations</h2></div>
                <div class="widget-content">
                     {% if cluster.analysis and cluster.analysis.rightsizing %}
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>Workload</th><th>Namespace</th><th>Metric</th><th>Current Request</th><th>Recommended Request</th></tr></thead>
                                <tbody>
                                {% for rec in cluster.analysis.rightsizing %}
                                    <tr>
                                        <td>{{ rec.workload }}</td>
                                        <td>{{ rec.namespace }}</td>
                                        <td><span class="tag code">{{ rec.metric }}</span></td>
                                        <td>{{ rec.current_request }}</td>
                                        <td><strong>{{ rec.recommended_request }}</strong></td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                     {% elif cluster.analysis and cluster.analysis.error %}
                        <div class="error-message">{{ cluster.analysis.error }}</div>
                     {% else %}
                        <p class="text-muted" style="text-align: center; padding: 2rem;">No specific rightsizing opportunities found at this time.</p>
                     {% endif %}
                </div>
            </div>
            <div class="widget">
                <div class="widget-header"><h2>Security Best Practices Checklist</h2></div>
                <div class="widget-content">
                    {% if cluster.security_insights %}
                    <table class="data-table security-table">
                         <thead><tr><th>Check</th><th>Status</th><th>Details</th></tr></thead>
                         <tbody>
                            {% for key, insight in cluster.security_insights.items() %}
                            <tr>
                                <td>{{ insight.description }}</td>
                                <td><span class="status-badge status-{{ 'active' if insight.status else 'failed' }}">{{ 'Passing' if insight.status else 'Attention' }}</span></td>
                                <td class="text-muted">
                                    {% if key == 'latest_platform_version' and not insight.status %}Current: {{ insight.current }}, Latest: {{ insight.latest }}{% elif key == 'logging_enabled' and not insight.status %}Missing: {{ insight.missing_logs | join(', ') }}{% else %}-{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                         </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">Security insights could not be generated for this cluster.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Workloads Tab -->
        <div id="workloads" class="tab-content">
            {% if (cluster.workloads is defined) and not cluster.workloads.error %}
                <div id="workload-graph-wrapper">
                    <div id="workload-graph-container">
                        <div class="graph-controls">
                            <input type="text" id="graph-search" placeholder="Search for a resource by name...">
                            <div class="graph-legend">
                                <div class="legend-item"><span class="legend-color diamond" style="background-color: #7c3aed;"></span> Ingress</div>
                                <div class="legend-item"><span class="legend-color" style="background-color: #2563eb;"></span> Service</div>
                                <div class="legend-item"><span class="legend-color dot" style="background-color: #16a34a;"></span> Pod</div>
                                <div class="legend-item"><span class="legend-color triangle" style="border-bottom-color: #64748b;"></span> Node</div>
                            </div>
                        </div>
                        <div id="workload-graph"></div>
                    </div>
                    <div id="graph-info-panel">
                        <button id="graph-info-close"><i data-feather="x"></i></button>
                        <h3 id="info-panel-title"></h3>
                        <div id="info-panel-body" class="info-grid"></div>
                    </div>
                </div>
                <div class="widget">
                    <div class="widget-header"><h2>Deployments</h2></div>
                    <div class="widget-content">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>Name</th><th>Namespace</th><th>Replicas</th></tr></thead>
                                <tbody>
                                    {% for dep in cluster.workloads.deployments %}
                                    <tr>
                                        <td>{{ dep.metadata.name }}</td>
                                        <td>{{ dep.metadata.namespace }}</td>
                                        {# --- FIX STARTS HERE --- #}
                                        <td><span class="status-badge status-{{ 'active' if dep.status and dep.status.readyReplicas == dep.spec.replicas else 'updating' }}">{{ (dep.status.readyReplicas or 0) if dep.status else 0 }}/{{ dep.spec.replicas }}</span></td>
                                        {# --- FIX ENDS HERE --- #}
                                    </tr>
                                    {% else %}
                                    <tr><td colspan="3" class="text-muted" style="text-align:center;">No deployments found.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                 <div class="widget">
                    <div class="widget-header"><h2>All Pods</h2></div>
                    <div class="widget-content">
                        <div class="table-container">
                             <table class="data-table">
                                <thead><tr><th>Name</th><th>Namespace</th><th>Node</th><th>Status</th><th>Restarts</th><th>Age</th></tr></thead>
                                <tbody>
                                    {% for pod in cluster.workloads.pods %}
                                    <tr>
                                        <td>{{ pod.metadata.name }}</td>
                                        <td>{{ pod.metadata.namespace }}</td>
                                        <td>{{ pod.spec.nodeName | default('N/A') }}</td>
                                        <td><span class="status-badge status-{{ pod.status.phase.lower() }}">{{ pod.status.phase }}</span></td>
                                        <td>{{ pod.restarts }}</td>
                                        <td>{{ pod.age }}</td>
                                    </tr>
                                    {% else %}
                                    <tr><td colspan="6" class="text-muted" style="text-align:center;">No pods found.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
             {% else %}
                 <div class="error-message-box"><strong>Could not load workload data.</strong>
                 <p>Could not connect to the Kubernetes API server or permissions are missing.
                    {% if cluster.workloads.error %}Reason: {{ cluster.workloads.error }}{% endif %}
                 </p></div>
             {% endif %}
        </div>

        <!-- Compute Tab -->
        <div id="compute" class="tab-content">
            <div class="widget">
                <div class="widget-header"><h2>Nodegroups & Compute Nodes</h2></div>
                <div class="widget-content">
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Name</th><th>Status</th><th>Mode</th><th>Instance Type(s)</th><th>K8s Version</th><th>Action</th></tr></thead>
                            <tbody>
                                {% for ng in cluster.nodegroups_data %}
                                <tr>
                                    <td>{{ ng.name }}</td>
                                    <td><span class="status-badge status-{{ ng.status.lower() if ng.status else 'unknown' }}">{{ ng.status }}</span></td>
                                    <td>{% if ng.is_karpenter_node %}<span class="tag code">Auto Mode</span>{% else %}<span class="tag">Managed</span>{% endif %}</td>
                                    <td>{{ ng.instanceTypes | join(', ') }}</td>
                                    <td>{{ ng.version }}</td>
                                    <td>
                                        {% if not ng.is_karpenter_node and ng.releaseVersion and ng.version and ng.releaseVersion < ng.version %}
                                        <button class="action-btn upgrade-btn" data-nodegroup-name="{{ ng.name }}"><i data-feather="chevrons-up"></i> Upgrade Now</button>
                                        {% else %}<span class="text-muted">N/A</span>{% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="6" class="text-muted" style="text-align: center;">No nodegroups or compute nodes found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add-ons Tab -->
        <div id="addons" class="tab-content">
             <div class="widget">
                <div class="widget-header"><h2>Cluster Add-ons</h2></div>
                <div class="widget-content">
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Name</th><th>Version</th><th>Status</th><th>Health</th><th>Owner</th><th>Publisher</th><th>Modified At</th></tr></thead>
                            <tbody>
                                {% for addon in cluster.addons %}
                                <tr>
                                    <td>{{ addon.addonName }}</td>
                                    <td>{{ addon.addonVersion }}</td>
                                    <td><span class="status-badge status-{{ addon.status.lower() if addon.status else 'unknown' }}">{{ addon.status }}</span></td>
                                    <td><span class="health-badge health-{{ addon.health_status.lower().replace('_', '-') }}">{{ addon.health_status.replace('_', ' ') | title }}</span></td>
                                    <td>{{ addon.owner }}</td>
                                    <td>{{ addon.publisher }}</td>
                                    <td>{{ addon.modifiedAt.strftime('%Y-%m-%d') if addon.modifiedAt else 'N/A' }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="7" class="text-muted" style="text-align: center;">No add-ons found for this cluster.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Observability Tab -->
        <div id="observability" class="tab-content">
            <div id="metrics-loading-state" style="display: none; text-align: center; padding: 40px;"><p class="text-muted">Loading metrics...</p></div>
            <div id="metrics-error-state" style="display: none; padding: 20px 0;"><p class="error-message">Could not load metrics data.</p></div>
            <div class="metrics-grid" style="display: none;">
                <div class="widget"><div class="widget-header"><h2>Requests</h2></div><div class="widget-content chart-widget-content"><canvas id="requestsChart"></canvas></div></div>
                <div class="widget"><div class="widget-header"><h2>Requests HTTP 4XX</h2></div><div class="widget-content chart-widget-content"><canvas id="requests4xxChart"></canvas></div></div>
                <div class="widget"><div class="widget-header"><h2>Requests HTTP 5XX</h2></div><div class="widget-content chart-widget-content"><canvas id="requests5xxChart"></canvas></div></div>
                <div class="widget"><div class="widget-header"><h2>Requests HTTP 429</h2></div><div class="widget-content chart-widget-content"><canvas id="requests429Chart"></canvas></div></div>
                <div class="widget"><div class="widget-header"><h2>Storage Size</h2></div><div class="widget-content chart-widget-content"><canvas id="storageSizeChart"></canvas></div></div>
                <div class="widget"><div class="widget-header"><h2>Scheduler Attempts</h2></div><div class="widget-content chart-widget-content"><canvas id="schedulerAttemptsChart"></canvas></div></div>
                <div class="widget"><div class="widget-header"><h2>Pending Pods</h2></div><div class="widget-content chart-widget-content"><canvas id="pendingPodsChart"></canvas></div></div>
                <div class="widget"><div class="widget-header"><h2>API Server Request Latency</h2></div><div class="widget-content chart-widget-content"><canvas id="latencyChart"></canvas></div></div>
                <div class="widget"><div class="widget-header"><h2>API Server Inflight Requests</h2></div><div class="widget-content chart-widget-content"><canvas id="inflightChart"></canvas></div></div>
            </div>
        </div>

        <!-- Cost Analysis Tab -->
        <div id="cost" class="tab-content">
            <div class="cost-grid">
                <div class="widget">
                    <div class="widget-header"><h2>Cost Breakdown by Service (30d)</h2></div>
                    <div class="widget-content chart-widget-content" id="cost-breakdown-container">
                        <canvas id="costBreakdownChart"></canvas>
                    </div>
                </div>
                <div class="widget">
                    <div class="widget-header"><h2>"What-If" Cost Calculator</h2></div>
                    <div class="widget-content">
                        <form id="what-if-form" class="what-if-form">
                            <label for="what-if-nodegroup">Select Nodegroup:</label>
                            <select id="what-if-nodegroup" name="nodegroup">
                                <option value="">-- Select a nodegroup --</option>
                                {% for ng in cluster.nodegroups_data %}{% if not ng.is_karpenter_node %}
                                <option value="{{ ng.name }}" data-instances="{{ ng.instanceTypes | join(',') }}" data-count="{{ ng.desiredSize }}">{{ ng.name }} ({{ ng.desiredSize }}x {{ ng.instanceTypes | join(',') }})</option>
                                {% endif %}{% endfor %}
                            </select>
                            <label for="what-if-target-instance">Target Instance Type:</label>
                            <input type="text" id="what-if-target-instance" name="target_instance" placeholder="e.g., m6i.large">
                            <button type="submit" class="action-button">Calculate Savings</button>
                        </form>
                        <div id="what-if-results">
                            <h4>Estimated Cost Impact:</h4>
                            <p id="what-if-results-text"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Machine Tab -->
        <div id="timemachine" class="tab-content">
            <div class="widget">
                <div class="widget-header">
                    <h2>Cluster Snapshots</h2>
                    <button id="create-snapshot-btn" class="action-button"><i data-feather="camera"></i> Create New Snapshot</button>
                </div>
                <div class="widget-content">
                    <p class="text-muted">Create point-in-time snapshots of the cluster's configuration to compare changes over time. Snapshots are stored in memory and will be lost on application restart.</p>
                    <ul id="snapshot-list" class="snapshot-list">
                        <!-- Snapshots will be loaded here by JS -->
                    </ul>
                </div>
            </div>
            <div class="widget">
                <div class="widget-header"><h2>Compare Snapshots</h2></div>
                <div class="widget-content">
                    <div class="snapshot-diff-selector">
                        <select id="diff-select-base"></select>
                        <span>vs.</span>
                        <select id="diff-select-compare"></select>
                        <button id="run-diff-btn" class="action-button">Compare</button>
                    </div>
                    <div id="diff-results-container" style="display:none;">
                        <h3 id="diff-results-title"></h3>
                        <div id="diff-results-grid" class="diff-results-grid"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="widget">
                <div class="widget-header">
                    <h2>Control Plane Logs (Last 10 minutes)</h2>
                    <select id="log-type-selector">
                        <option value="api">api</option><option value="audit">audit</option><option value="authenticator">authenticator</option>
                        <option value="scheduler">scheduler</option><option value="controllerManager">controllerManager</option>
                    </select>
                </div>
                <div class="widget-content"><pre id="log-output" class="log-box">Select a log type to begin streaming...</pre></div>
            </div>
        </div>

    </div>
    {% endif %}
{% endblock %}

{% block scripts_extra %}
<script>
    const CLUSTER_INFO = {
        accountId: '{{ cluster.account_id }}',
        region: '{{ cluster.region }}',
        name: '{{ cluster.name }}'
    };
    const workloadsData = {{ cluster.workloads | tojson | safe if cluster.workloads else 'null' }};
    let workloadGraphRendered = false;
    let visNetwork, visNodes, visEdges;
    
    // --- Global State for Page ---
    let eventSource = null;
    let logStreamStarted = false;
    let activeTab = 'overview';

    function openTab(evt, tabName) {
        activeTab = tabName;
        // Close any active streams when switching tabs
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }

        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
        document.getElementById(tabName).style.display = 'block';
        evt.currentTarget.classList.add('active');

        if (tabName === 'workloads' && !workloadGraphRendered) {
            renderWorkloadGraph();
            workloadGraphRendered = true;
        } else if (tabName === 'logs' && !logStreamStarted) {
            startLogStream();
            logStreamStarted = true;
        } else if (tabName === 'cost') {
            loadCostBreakdown();
        } else if (tabName === 'timemachine') {
            loadSnapshots();
        }
        feather.replace();
    }
    
    // --- START: Workload Graph Logic ---
    function renderWorkloadGraph() {
        const container = document.getElementById('workload-graph');
        if (!workloadsData || workloadsData.error || !workloadsData.map_nodes) {
            container.innerHTML = '<p class="text-muted" style="text-align:center; padding: 50px;">Could not render workload graph. Data is unavailable.</p>';
            return;
        }

        visNodes = new vis.DataSet(workloadsData.map_nodes);
        visEdges = new vis.DataSet(workloadsData.map_edges);
        
        const data = { nodes: visNodes, edges: visEdges };
        const options = {
            nodes: {
                shape: 'dot', size: 18,
                font: { size: 14, color: 'var(--text-secondary)' },
                borderWidth: 2,
            },
            edges: {
                width: 1,
                color: { color: 'var(--border-color)', highlight: '#86efac', hover: '#6ee7b7' },
                smooth: { type: 'continuous' }
            },
            groups: {
                ingress: { color: { background: '#7c3aed', border: '#a78bfa', highlight: { background: '#8b5cf6', border: '#c4b5fd' } }, shape: 'diamond' },
                svc: { color: { background: '#2563eb', border: '#60a5fa', highlight: { background: '#3b82f6', border: '#93c5fd' } }, shape: 'square' },
                pod: { color: { background: '#16a34a', border: '#4ade80', highlight: { background: '#22c55e', border: '#86efac' } }, shape: 'dot' },
                node: { color: { background: '#64748b', border: '#94a3b8', highlight: { background: '#94a3b8', border: '#cbd5e1' } }, shape: 'triangle' },
            },
            physics: {
                solver: 'forceAtlas2Based',
                forceAtlas2Based: { gravitationalConstant: -40, centralGravity: 0.01, springLength: 230, springConstant: 0.1 },
                maxVelocity: 146, minVelocity: 0.75,
                stabilization: { iterations: 150, fit: true },
            },
            interaction: { tooltipDelay: 200, hideEdgesOnDrag: true, hover: true, navigationButtons: true },
            layout: { improvedLayout: true }
        };

        visNetwork = new vis.Network(container, data, options);
        setupGraphInteractions();
    }

    function setupGraphInteractions() {
        const infoPanel = document.getElementById('graph-info-panel');
        const searchInput = document.getElementById('graph-search');

        visNetwork.on('click', (properties) => {
            if (properties.nodes.length > 0) {
                const nodeId = properties.nodes[0];
                const nodeData = visNodes.get(nodeId);
                populateInfoPanel(nodeData.details);
                highlightNodeAndConnections(nodeId);
            } else {
                resetHighlightAndPanel();
            }
        });

        document.getElementById('graph-info-close').addEventListener('click', resetHighlightAndPanel);

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) {
                resetHighlightAndPanel();
                return;
            }
            const foundNode = workloadsData.map_nodes.find(n => n.label.toLowerCase().includes(searchTerm));
            if (foundNode) {
                visNetwork.focus(foundNode.id, { scale: 1.2, animation: true });
                populateInfoPanel(foundNode.details);
                highlightNodeAndConnections(foundNode.id);
            }
        });
    }

    function populateInfoPanel(details) {
        const panel = document.getElementById('graph-info-panel');
        const titleEl = document.getElementById('info-panel-title');
        const bodyEl = document.getElementById('info-panel-body');

        titleEl.textContent = `${details.kind}: ${details.name}`;
        let html = '';
        for (const [key, value] of Object.entries(details)) {
            if (key === 'kind' || key === 'name') continue;
            let displayValue = value;
            if (Array.isArray(value)) {
                displayValue = value.length > 0 ? `<ul>${value.map(item => `<li>${JSON.stringify(item)}</li>`).join('')}</ul>` : 'None';
            } else if (typeof value === 'object' && value !== null) {
                displayValue = JSON.stringify(value, null, 2);
            } else {
                displayValue = `<span>${value || 'N/A'}</span>`;
            }
            const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<strong>${displayKey}</strong><div>${displayValue}</div>`;
        }
        bodyEl.innerHTML = html;
        panel.style.display = 'block';
        feather.replace();
    }

    function highlightNodeAndConnections(nodeId) {
        const allNodes = visNodes.get({ returnType: 'Object' });
        const allEdges = visEdges.get();
        const connectedNodes = visNetwork.getConnectedNodes(nodeId);
        connectedNodes.push(nodeId);

        for (const id in allNodes) {
            const node = allNodes[id];
            if (!connectedNodes.includes(id)) {
                node.color = { border: '#334155', background: '#1e293b' };
                node.font = { color: '#475569' };
            }
        }
        visNodes.update(Object.values(allNodes));

        allEdges.forEach(edge => {
            if (edge.from !== nodeId && edge.to !== nodeId) {
                edge.color = '#334155';
            } else {
                 edge.color = { color: '#86efac', highlight: '#86efac' };
            }
        });
        visEdges.update(allEdges);
    }
    
    function resetHighlightAndPanel() {
        document.getElementById('graph-info-panel').style.display = 'none';
        visNodes.update(workloadsData.map_nodes);
        visEdges.update(workloadsData.map_edges);
        document.getElementById('graph-search').value = '';
    }
    // --- END: Workload Graph Logic ---
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('overview').style.display = 'block';
        feather.replace();

        // --- FIXED: Refresh Button Logic ---
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async () => {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i data-feather="loader" class="spin"></i> Refreshing...';
                feather.replace();
                try {
                    const url = `/api/refresh-cluster/${CLUSTER_INFO.accountId}/${CLUSTER_INFO.region}/${CLUSTER_INFO.name}`;
                    const response = await fetch(url, { method: 'POST' });
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        const result = await response.json();
                        alert('Failed to refresh data: ' + (result.error || 'Unknown error'));
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i data-feather="refresh-cw"></i> Refresh Data';
                        feather.replace();
                    }
                } catch (error) {
                    alert('An error occurred while trying to refresh data.');
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i data-feather="refresh-cw"></i> Refresh Data';
                    feather.replace();
                }
            });
        }

        // Nodegroup Upgrade Button Logic
        document.querySelectorAll('.upgrade-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                if (!confirm(`Are you sure you want to upgrade nodegroup "${btn.dataset.nodegroupName}"?`)) return;
                
                btn.disabled = true;
                btn.innerHTML = '<i data-feather="loader" class="spin"></i> Upgrading...';
                feather.replace();

                const response = await fetch('/api/upgrade-nodegroup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountId: CLUSTER_INFO.accountId, region: CLUSTER_INFO.region,
                        clusterName: CLUSTER_INFO.name, nodegroupName: btn.dataset.nodegroupName,
                    }),
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`Upgrade initiated successfully!`);
                    window.location.reload();
                } else {
                    alert(`Upgrade failed: ${result.error}`);
                    btn.disabled = false;
                }
            });
        });

        // --- FIXED: High-Performance Log Streaming Logic ---
        const logSelector = document.getElementById('log-type-selector');
        const logOutput = document.getElementById('log-output');
        const MAX_LOG_LINES = 500; // Cap to prevent browser crash

        function startLogStream() {
            if(activeTab !== 'logs') return;
            if (eventSource) eventSource.close();
            logOutput.innerHTML = ''; // Clear previous logs
            
            const connectingMsg = document.createElement('div');
            connectingMsg.className = 'text-muted';
            connectingMsg.textContent = 'Connecting to log stream...';
            logOutput.appendChild(connectingMsg);

            const logType = logSelector.value;
            const url = `/api/logs/${CLUSTER_INFO.accountId}/${CLUSTER_INFO.region}/${CLUSTER_INFO.name}/${logType}`;
            eventSource = new EventSource(url);
            let firstMessage = true;

            eventSource.onmessage = function(event) {
                if (firstMessage) {
                    logOutput.innerHTML = ''; // Clear "Connecting..." message
                    firstMessage = false;
                }

                const data = JSON.parse(event.data);
                const logLine = document.createElement('div');
                logLine.className = 'log-line';

                if (data.error) {
                    logLine.className += ' error';
                    logLine.textContent = `ERROR: ${data.error}`;
                    eventSource.close();
                } else {
                    if (data.anomaly) { // Check for anomaly flag
                        logLine.classList.add('anomaly');
                    }
                    const message = data.message || JSON.stringify(data);
                    const timestamp = data.timestamp ? new Date(data.timestamp).toISOString() : '';
                    logLine.textContent = `[${timestamp}] ${message}`;
                }
                
                logOutput.appendChild(logLine);

                // Efficiently remove old lines if limit is exceeded
                if (logOutput.childElementCount > MAX_LOG_LINES) {
                    logOutput.removeChild(logOutput.firstChild);
                }
                
                // Auto-scroll to the bottom
                logOutput.scrollTop = logOutput.scrollHeight;
            };

            eventSource.onerror = function() {
                const errorLine = document.createElement('div');
                errorLine.className = 'log-line error';
                errorLine.textContent = 'Connection to log stream lost or stream ended.';
                logOutput.appendChild(errorLine);
                logOutput.scrollTop = logOutput.scrollHeight;
                if (eventSource) eventSource.close();
            };
        }
        if(logSelector) logSelector.addEventListener('change', startLogStream);


        // Observability Metrics Logic
        const observabilityTabButton = document.querySelector('button[onclick*="observability"]');
        let metricsLoaded = false;
        let metricCharts = {};
        function getChartBaseOptions() {
            return {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }}, ticks: { color: 'var(--text-secondary)' }, grid: { color: 'var(--border-color)' }},
                    y: { beginAtZero: true, ticks: { color: 'var(--text-secondary)' }, grid: { color: 'var(--border-color)' }}
                },
                plugins: { legend: { position: 'bottom', labels: { color: 'var(--text-secondary)', usePointStyle: true, boxHeight: 8, padding: 20 } }},
                interaction: { mode: 'index', intersect: false },
                elements: { point: { radius: 0 } }
            };
        }
        function renderMetricChart(canvasId, datasets) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (metricCharts[canvasId]) metricCharts[canvasId].destroy();
            metricCharts[canvasId] = new Chart(ctx, { type: 'line', data: {
                datasets: datasets.map(ds => ({
                    label: ds.label,
                    data: ds.timestamps.map((ts, i) => ({ x: ts, y: ds.values[i] })),
                    borderColor: ds.color, borderWidth: 2, tension: 0.1
                }))
            }, options: getChartBaseOptions()});
        }
        function processAndRenderCharts(metricsData) {
            const chartConfigs = [
                { id: 'requestsChart', key: 'requests', label: 'Total', color: '#4A90E2' },
                { id: 'requests4xxChart', key: 'requests_4xx', label: '4XX Errors', color: '#F5A623' },
                { id: 'requests5xxChart', key: 'requests_5xx', label: '5XX Errors', color: '#D0021B' },
                { id: 'requests429Chart', key: 'requests_429', label: '429 Throttles', color: '#BD10E0' },
                { id: 'storageSizeChart', key: 'storage_size', label: 'Size', color: '#50E3C2' }
            ];
            chartConfigs.forEach(c => {
                if (metricsData[c.key] && metricsData[c.key].values.length > 0) {
                    renderMetricChart(c.id, [{...metricsData[c.key], label: c.label, color: c.color}]);
                }
            });
            const multiLineCharts = [
                { id: 'schedulerAttemptsChart', series: [{ k: 'scheduler_attempts_scheduled', l: 'Scheduled', c: '#7ED321' }, { k: 'scheduler_attempts_unschedulable', l: 'Unschedulable', c: '#F5A623' }, { k: 'scheduler_attempts_error', l: 'Error', c: '#D0021B' }] },
                { id: 'pendingPodsChart', series: [{ k: 'pending_pods_gated', l: 'Gated', c: '#4A90E2' }, { k: 'pending_pods_unschedulable', l: 'Unschedulable', c: '#F5A623' }, { k: 'pending_pods_activeq', l: 'ActiveQ', c: '#7ED321' }] },
                { id: 'latencyChart', series: [{ k: 'latency_get', l: 'GET P99', c: '#4A90E2' }, { k: 'latency_post', l: 'POST P99', c: '#50E3C2' }, { k: 'latency_delete', l: 'DELETE P99', c: '#D0021B' }] },
                { id: 'inflightChart', series: [{ k: 'inflight_mutating', l: 'Mutating', c: '#F5A623' }, { k: 'inflight_readonly', l: 'Read-only', c: '#4A90E2' }] }
            ];
            multiLineCharts.forEach(c => {
                const datasets = c.series.map(s => metricsData[s.k] && metricsData[s.k].values.length > 0 ? { ...metricsData[s.k], label: s.l, color: s.c } : null).filter(Boolean);
                if(datasets.length > 0) renderMetricChart(c.id, datasets);
            });
        }
        async function loadMetrics() {
            if (metricsLoaded) return;
            const loadingState = document.getElementById('metrics-loading-state');
            const grid = document.querySelector('#observability .metrics-grid');
            const errorState = document.getElementById('metrics-error-state');
            
            loadingState.style.display = 'block';
            grid.style.display = 'none';
            errorState.style.display = 'none';

            try {
                const url = `/api/metrics/${CLUSTER_INFO.accountId}/${CLUSTER_INFO.region}/${CLUSTER_INFO.name}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error((await response.json()).error || 'Failed to fetch metrics');
                
                const metricsData = await response.json();
                if (Object.keys(metricsData).length === 0 || Object.values(metricsData).every(d => d.values.length === 0)) {
                    throw new Error("No metrics data returned. Ensure Container Insights is enabled.");
                }
                
                processAndRenderCharts(metricsData);
                metricsLoaded = true;
                grid.style.display = 'grid';
            } catch (error) {
                errorState.querySelector('.error-message').textContent = error.message;
                errorState.style.display = 'block';
            } finally {
                loadingState.style.display = 'none';
            }
        }
        if (observabilityTabButton) observabilityTabButton.addEventListener('click', loadMetrics, { once: true });
        
        // --- START: Cost Analysis Logic ---
        let costChart;
        async function loadCostBreakdown() {
            const container = document.getElementById('cost-breakdown-container');
            container.innerHTML = '<p class="text-muted" style="text-align:center;padding:2rem;">Loading cost breakdown...</p><canvas id="costBreakdownChart"></canvas>';
            try {
                const url = `/api/cost-breakdown/${CLUSTER_INFO.accountId}/${CLUSTER_INFO.region}/${CLUSTER_INFO.name}`;
                const response = await fetch(url);
                const data = await response.json();
                if (!response.ok || data.error) throw new Error(data.error || 'Failed to fetch cost breakdown.');

                const labels = data.map(item => item.service);
                const values = data.map(item => item.amount);
                
                const ctx = document.getElementById('costBreakdownChart').getContext('2d');
                if (costChart) costChart.destroy();
                costChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cost by Service',
                            data: values,
                            backgroundColor: ['#4A90E2', '#F5A623', '#50E3C2', '#BD10E0', '#B8E986', '#7ED321', '#D0021B'],
                            borderColor: '#1E293B',
                            borderWidth: 3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: 'var(--text-secondary)' } } } }
                });

            } catch(e) {
                container.innerHTML = `<p class="error-message">${e.message}</p><canvas id="costBreakdownChart"></canvas>`;
            }
        }
        
        document.getElementById('what-if-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const nodegroup = form.nodegroup.value;
            const selectedOption = form.nodegroup.options[form.nodegroup.selectedIndex];
            const currentInstances = selectedOption.dataset.instances;
            const instanceCount = selectedOption.dataset.count;
            const targetInstance = form.target_instance.value;
            const resultsDiv = document.getElementById('what-if-results');
            const resultsText = document.getElementById('what-if-results-text');

            if (!nodegroup || !targetInstance) {
                alert('Please select a nodegroup and enter a target instance type.');
                return;
            }
            resultsText.textContent = 'Calculating...';
            resultsDiv.style.display = 'block';

            try {
                const res = await fetch(`/api/cost-what-if/${CLUSTER_INFO.accountId}/${CLUSTER_INFO.region}/${CLUSTER_INFO.name}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        current_instance_type: currentInstances.split(',')[0], // Simple: use first instance type
                        target_instance_type: targetInstance,
                        instance_count: parseInt(instanceCount, 10)
                    })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);

                const savings = data.monthly_savings;
                let savingsText = savings > 0 
                    ? `Estimated monthly savings of <strong>$${savings.toFixed(2)}</strong>.`
                    : `Estimated monthly cost increase of <strong>$${Math.abs(savings).toFixed(2)}</strong>.`;
                
                resultsText.innerHTML = `Changing ${instanceCount}x ${currentInstances} to ${targetInstance} could result in: <br>${savingsText}<br><small class="text-muted">Note: This is an estimate based on on-demand pricing and may not be exact.</small>`;

            } catch (e) {
                resultsText.innerHTML = `<span style="color: #f87171;">Error: ${e.message}</span>`;
            }
        });
        // --- END: Cost Analysis Logic ---

        // --- START: Time Machine Logic ---
        const snapshotList = document.getElementById('snapshot-list');
        const diffBaseSelect = document.getElementById('diff-select-base');
        const diffCompareSelect = document.getElementById('diff-select-compare');

        async function loadSnapshots() {
            try {
                const url = `/api/snapshots/${CLUSTER_INFO.accountId}/${CLUSTER_INFO.region}/${CLUSTER_INFO.name}`;
                const res = await fetch(url);
                const snapshots = await res.json();
                snapshotList.innerHTML = '';
                diffBaseSelect.innerHTML = '<option value="">Select Base</option>';
                diffCompareSelect.innerHTML = '<option value="">Select to Compare</option>';

                if (snapshots.length === 0) {
                    snapshotList.innerHTML = '<p class="text-muted">No snapshots created yet.</p>';
                    return;
                }

                snapshots.sort((a, b) => b.timestamp.localeCompare(a.timestamp)).forEach(s => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${s.id}</span> <span class="text-muted">${new Date(s.timestamp).toLocaleString()}</span>`;
                    snapshotList.appendChild(li);
                    
                    const optionBase = document.createElement('option');
                    optionBase.value = s.id;
                    optionBase.textContent = `${s.id.split('_').pop()} (${new Date(s.timestamp).toLocaleTimeString()})`;
                    diffBaseSelect.appendChild(optionBase);
                    
                    const optionCompare = document.createElement('option');
                    optionCompare.value = s.id;
                    optionCompare.textContent = `${s.id.split('_').pop()} (${new Date(s.timestamp).toLocaleTimeString()})`;
                    diffCompareSelect.appendChild(optionCompare);
                });
            } catch (e) {
                snapshotList.innerHTML = `<li class="error-message">${e.message}</li>`;
            }
        }
        
        document.getElementById('create-snapshot-btn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.disabled = true;
            btn.innerHTML = '<i data-feather="loader" class="spin"></i> Creating...';
            feather.replace();
            try {
                const url = `/api/snapshot/${CLUSTER_INFO.accountId}/${CLUSTER_INFO.region}/${CLUSTER_INFO.name}`;
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                await loadSnapshots();
            } catch (e) {
                alert(`Failed to create snapshot: ${e.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-feather="camera"></i> Create New Snapshot';
                feather.replace();
            }
        });

        document.getElementById('run-diff-btn').addEventListener('click', async () => {
            const baseId = diffBaseSelect.value;
            const compareId = diffCompareSelect.value;
            const resultsContainer = document.getElementById('diff-results-container');
            const resultsGrid = document.getElementById('diff-results-grid');
            const resultsTitle = document.getElementById('diff-results-title');

            if (!baseId || !compareId) { alert('Please select two snapshots to compare.'); return; }
            if (baseId === compareId) { alert('Please select two different snapshots.'); return; }
            
            resultsGrid.innerHTML = '<p class="text-muted">Running comparison...</p>';
            resultsContainer.style.display = 'block';

            try {
                const url = `/api/snapshot-diff?base_id=${encodeURIComponent(baseId)}&compare_id=${encodeURIComponent(compareId)}`;
                const res = await fetch(url);
                const diff = await res.json();
                if (!res.ok) throw new Error(diff.error);
                
                const baseLabel = diffBaseSelect.options[diffBaseSelect.selectedIndex].text;
                const compareLabel = diffCompareSelect.options[diffCompareSelect.selectedIndex].text;
                resultsTitle.textContent = `Comparing ${baseLabel} vs ${compareLabel}`;
                resultsGrid.innerHTML = ''; // Clear loading message

                Object.entries(diff).forEach(([resourceType, changes]) => {
                    if (changes.added.length === 0 && changes.removed.length === 0 && changes.changed.length === 0) return;
                    
                    const card = document.createElement('div');
                    card.className = 'diff-card';
                    let html = `<h4>${resourceType}</h4>`;
                    
                    changes.added.forEach(item => { html += `<div class="diff-item diff-added">+ ${item.name} (${item.namespace})</div>`; });
                    changes.removed.forEach(item => { html += `<div class="diff-item diff-removed">- ${item.name} (${item.namespace})</div>`; });
                    changes.changed.forEach(item => { 
                        html += `<div class="diff-item diff-changed">~ ${item.name} (${item.namespace})`
                        html += `<ul>${item.diff.map(d => `<li>${d}</li>`).join('')}</ul></div>`
                    });

                    card.innerHTML = html;
                    resultsGrid.appendChild(card);
                });

                if (resultsGrid.innerHTML === '') {
                    resultsGrid.innerHTML = '<p class="text-muted">No differences found between the selected snapshots.</p>';
                }

            } catch(e) {
                 resultsGrid.innerHTML = `<p class="error-message">Diff failed: ${e.message}</p>`;
            }
        });
        // --- END: Time Machine Logic ---
    });
</script>
{% endblock %}
