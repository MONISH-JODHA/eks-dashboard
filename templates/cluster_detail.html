{% extends "base.html" %}

{% block title %}Cluster Details: {{ cluster.name }}{% endblock %}
{% block page_title %}Cluster Details{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Vis Network for workload graph -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />

    <!-- Page-specific styles are now mostly in style.css, this block is for overrides and specifics -->
    <style>
        .widget-content[style*="padding: 0"] .table-container {
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        .log-status-list {
            list-style-type: none; padding: 0; margin: 0;
        }
        .log-status-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);
        }
        .log-status-item:last-child { border-bottom: none; }
        .log-name { font-weight: 500; }
        .no-data-message {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; min-height: 250px; text-align: center; color: var(--text-secondary);
        }
        .no-data-message p { margin: 0.25rem 0; }

        /* Enhanced visibility and styling for Vis.js navigation buttons */
        .vis-navigation .vis-button {
            width: 32px !important; height: 32px !important; padding: 0 !important;
            display: flex !important; align-items: center !important; justify-content: center !important;
            font-size: 20px !important; font-weight: bold; color: var(--text-primary) !important;
            background-color: var(--surface-color) !important; border: 1px solid var(--border-color) !important;
            border-radius: 6px !important; box-shadow: 0 1px 3px rgba(0,0,0,0.08) !important;
            transition: all 0.2s ease-in-out;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        .vis-navigation .vis-button:hover {
            background-color: var(--bg-color) !important; border-color: var(--primary-color) !important;
            transform: translateY(-1px);
        }
        .vis-navigation .vis-button::before { line-height: 1; }
        .vis-navigation .vis-button.vis-zoomIn::before { content: '+' !important; }
        .vis-navigation .vis-button.vis-zoomOut::before { content: '−' !important; } /* Minus sign */
        .vis-navigation .vis-button.vis-zoomExtends::before { content: '⤧' !important; } /* Fit to screen symbol */
        .vis-navigation .vis-button.vis-up::before { content: '↑' !important; }
        .vis-navigation .vis-button.vis-down::before { content: '↓' !important; }
        .vis-navigation .vis-button.vis-left::before { content: '←' !important; }
        .vis-navigation .vis-button.vis-right::before { content: '→' !important; }
    </style>
{% endblock %}

{% block content %}
    <a href="{{ url_for('list_clusters') }}" class="back-link"><i data-feather="arrow-left"></i> Back to Clusters</a>
    <h2 class="cluster-detail-title">{{ cluster.name or "Unknown Cluster" }}</h2>

    {% if cluster.errors %}
        <div class="error-message-box">
            <strong>Error fetching cluster details:</strong>
            <ul>{% for error in cluster.errors %}<li>{{ error }}</li>{% endfor %}</ul>
        </div>
    {% else %}
    <div class="tab-container">
        <div class="tab-nav">
            <button class="tab-link active" onclick="openTab(event, 'overview')"><i data-feather="layout"></i>Overview</button>
            <button class="tab-link" onclick="openTab(event, 'compute')"><i data-feather="hard-drive"></i>Compute</button>
            <button class="tab-link" onclick="openTab(event, 'addons')"><i data-feather="box"></i>Add-ons</button>
            <button class="tab-link" onclick="openTab(event, 'workloads')"><i data-feather="cpu"></i>Workloads</button>
            <button class="tab-link" onclick="openTab(event, 'observability')"><i data-feather="bar-chart-2"></i>Observability</button>
            <button class="tab-link" onclick="openTab(event, 'insights')"><i data-feather="zap"></i>Analysis & Insights</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="widget">
                <div class="widget-header">
                    <h2>Cluster Summary</h2>
                    <button id="refreshBtn" class="action-button" title="Refresh data for this cluster">
                        <i data-feather="refresh-cw"></i> Refresh Data
                    </button>
                </div>
                <div class="widget-content">
                    <div class="summary-grid">
                        <div><strong>ARN:</strong> <span class="code">{{ cluster.arn }}</span></div>
                        <div><strong>Status:</strong> <span class="status-badge status-{{ cluster.status.lower() if cluster.status else 'unknown' }}">{{ cluster.status }}</span></div>
                        <div><strong>Region:</strong> <span>{{ cluster.region }}</span></div>
                        <div><strong>Account ID:</strong> <span>{{ cluster.account_id }}</span></div>
                        <div><strong>K8s Version:</strong> <span>{{ cluster.version }}</span></div>
                        <div><strong>Platform Version:</strong> <span>{{ cluster.platformVersion }}</span></div>
                        <div><strong>Created At:</strong> <span>{{ cluster.createdAt.strftime('%Y-%m-%d %H:%M Z') if cluster.createdAt else 'N/A' }}</span></div>
                        <div><strong>OIDC Provider:</strong> <span class="code">{{ cluster.oidc_provider_url or 'Not available' }}</span></div>
                    </div>
                </div>
            </div>
            <div class="widget">
                <div class="widget-header"><h2>Networking & Security</h2></div>
                <div class="widget-content">
                     <div class="summary-grid">
                        <div><strong>VPC ID:</strong> <span class="code">{{ cluster.networking.vpcId or 'N/A' }}</span></div>
                        <div><strong>Endpoint Public Access:</strong> <span class="status-badge status-{{ 'failed' if cluster.networking.endpointPublicAccess else 'active' }}">{{ 'Enabled' if cluster.networking.endpointPublicAccess else 'Disabled' }}</span></div>
                        <div><strong>Endpoint Private Access:</strong> <span class="status-badge status-{{ 'active' if cluster.networking.endpointPrivateAccess else 'failed' }}">{{ 'Enabled' if cluster.networking.endpointPrivateAccess else 'Disabled' }}</span></div>
                        <div><strong>Subnets:</strong> <div class="tags-container" style="margin-top: 5px;">{% for id in cluster.networking.subnetIds %}<span class="tag code">{{ id }}</span>{% else %}<span>N/A</span>{% endfor %}</div></div>
                    </div>
                </div>
            </div>
            {% if cluster.health_issues %}
            <div class="widget">
                <div class="widget-header"><h2><i data-feather="alert-circle" style="color: var(--status-updating);"></i> Health Issues</h2></div>
                <div class="widget-content">
                    {% for issue in cluster.health_issues %}
                    <div class="health-issue-box">
                        <strong class="code">{{ issue.code }}</strong>
                        <p>{{ issue.message }}</p>
                        <span>Resource IDs: {% for id in issue.resourceIds %}<span class="tag code">{{ id }}</span>{% endfor %}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Compute Tab -->
        <div id="compute" class="tab-content">
            <div class="widget">
                <div class="widget-header"><h2>Nodegroups & Compute Nodes</h2></div>
                <div class="widget-content" style="padding:0;">
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Name</th><th>Status</th><th>Mode</th><th>Instance Type(s)</th><th>K8s Version</th><th>Action</th></tr></thead>
                            <tbody>
                                {% for ng in cluster.nodegroups_data %}
                                <tr>
                                    <td>{{ ng.name }}</td>
                                    <td><span class="status-badge status-{{ ng.status.lower() if ng.status else 'unknown' }}">{{ ng.status }}</span></td>
                                    <td>{% if ng.is_karpenter_node %}<span class="tag">Auto Mode</span>{% else %}<span class="tag">Managed</span>{% endif %}</td>
                                    <td>{{ ng.instanceTypes | join(', ') }}</td>
                                    <td>{{ ng.version }}</td>
                                    <td>
                                        {% if not ng.is_karpenter_node and ng.releaseVersion and ng.version and ng.version in ng.releaseVersion %}
                                        <button class="action-btn upgrade-btn" data-nodegroup-name="{{ ng.name }}"><i data-feather="chevrons-up"></i> Upgrade Now</button>
                                        {% else %}<span class="text-muted">Up to date</span>{% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="6" class="text-muted" style="text-align: center; padding: 2rem;">No nodegroups or compute nodes found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add-ons Tab -->
        <div id="addons" class="tab-content">
             <div class="widget">
                <div class="widget-header"><h2>Cluster Add-ons</h2></div>
                <div class="widget-content" style="padding:0;">
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Name</th><th>Version</th><th>Status</th><th>Health</th><th>Owner</th><th>Publisher</th><th>Modified At</th></tr></thead>
                            <tbody>
                                {% for addon in cluster.addons %}
                                <tr>
                                    <td>{{ addon.addonName }}</td>
                                    <td>{{ addon.addonVersion }}</td>
                                    <td><span class="status-badge status-{{ addon.status.lower() if addon.status else 'unknown' }}">{{ addon.status }}</span></td>
                                    <td><span class="health-badge health-{{ addon.health_status.lower().replace('_', '-') }}">{{ addon.health_status.replace('_', ' ') | title }}</span></td>
                                    <td>{{ addon.owner }}</td>
                                    <td>{{ addon.publisher }}</td>
                                    <td>{{ addon.modifiedAt.strftime('%Y-%m-%d') if addon.modifiedAt else 'N/A' }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="7" class="text-muted" style="text-align: center; padding: 2rem;">No add-ons found for this cluster.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workloads Tab -->
        <div id="workloads" class="tab-content">
            {% if (cluster.workloads is defined) and not cluster.workloads.error %}
                 <div class="widget">
                    <div class="widget-header">
                        <h2><i data-feather="share-2"></i> Workload Relationship Map</h2>
                    </div>
                    <div class="widget-content" style="padding: 0;">
                        <div id="workload-graph-wrapper">
                            <div class="graph-controls-header">
                                <input type="text" id="graph-search" placeholder="Search for a resource by name...">
                                <div class="graph-legend">
                                    <div class="legend-item"><span class="legend-shape diamond"></span> Ingress</div>
                                    <div class="legend-item"><span class="legend-shape square"></span> Service</div>
                                    <div class="legend-item"><span class="legend-shape dot"></span> Pod</div>
                                    <div class="legend-item"><span class="legend-shape triangle"></span> Node</div>
                                </div>
                            </div>
                            <div id="workload-graph"></div>
                            <div id="graph-info-panel">
                                <div id="graph-info-header">
                                    <h3 id="info-panel-title"></h3>
                                    <button id="graph-info-close"><i data-feather="x"></i></button>
                                </div>
                                <div id="info-panel-body" class="info-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="widget">
                    <div class="widget-header"><h2>Deployments</h2></div>
                    <div class="widget-content" style="padding:0;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead><tr><th>Name</th><th>Namespace</th><th>Replicas</th></tr></thead>
                                <tbody>
                                    {% for dep in cluster.workloads.deployments %}
                                    <tr>
                                        <td>{{ dep.metadata.name }}</td>
                                        <td>{{ dep.metadata.namespace }}</td>
                                        <td><span class="status-badge status-{{ 'active' if dep.status and dep.status.readyReplicas == dep.spec.replicas else 'updating' }}">{{ (dep.status.readyReplicas or 0) if dep.status else 0 }}/{{ dep.spec.replicas }}</span></td>
                                    </tr>
                                    {% else %}
                                    <tr><td colspan="3" class="text-muted" style="text-align:center; padding: 2rem;">No deployments found.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                 <div class="widget">
                    <div class="widget-header"><h2>All Pods</h2></div>
                    <div class="pod-filters-bar">
                         <input type="text" id="pod-name-filter" placeholder="Filter by pod name...">
                         <select id="pod-namespace-filter"></select>
                         <select id="pod-status-filter">
                             <option value="all">All Statuses</option>
                             <option value="Running">Running</option>
                             <option value="Pending">Pending</option>
                             <option value="Succeeded">Succeeded</option>
                             <option value="Failed">Failed</option>
                             <option value="Unknown">Unknown</option>
                         </select>
                    </div>
                    <div class="widget-content" style="padding:0;">
                        <div class="table-container">
                             <table class="data-table" id="all-pods-table">
                                <thead><tr><th>Name</th><th>Namespace</th><th>Node</th><th>Status</th><th>Restarts</th><th>Age</th></tr></thead>
                                <tbody>
                                    {% for pod in cluster.workloads.pods %}
                                    <tr data-name="{{ pod.metadata.name.lower() }}" data-namespace="{{ pod.metadata.namespace }}" data-status="{{ pod.status.phase }}">
                                        <td>{{ pod.metadata.name }}</td>
                                        <td>{{ pod.metadata.namespace }}</td>
                                        <td>{{ pod.spec.nodeName | default('N/A') }}</td>
                                        <td><span class="status-badge status-{{ pod.status.phase.lower() }}">{{ pod.status.phase }}</span></td>
                                        <td>{{ pod.restarts }}</td>
                                        <td>{{ pod.age }}</td>
                                    </tr>
                                    {% else %}
                                    <tr><td colspan="6" class="text-muted" style="text-align:center; padding: 2rem;">No pods found.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
             {% else %}
                <div class="widget-content">
                     <div class="error-message-box"><strong>Could not load workload data.</strong>
                     <p>Could not connect to the Kubernetes API server or permissions are missing.
                        {% if cluster.workloads.error %}Reason: {{ cluster.workloads.error }}{% endif %}
                     </p></div>
                 </div>
             {% endif %}
        </div>

        <!-- Observability Tab -->
        <div id="observability" class="tab-content">
            <div id="metrics-loading-state"><p class="text-muted">Loading metrics...</p></div>
            <div id="metrics-error-state" style="display: none;"><p class="error-message">Could not load metrics data.</p></div>
            
            <div class="metrics-container" style="display: none;">
                <h3 class="section-title">Cluster Health Summary</h3>
                <div class="metrics-grid-2col">
                    <div class="widget"><div class="widget-header"><h2>Node Status</h2></div><div class="widget-content chart-widget-content"><canvas id="nodeStatusChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Container Restarts (Sum)</h2></div><div class="widget-content chart-widget-content"><canvas id="containerRestartsChart"></canvas></div></div>
                </div>
                
                <h3 class="section-title">Nodes Status and Capacity</h3>
                <div class="metrics-grid-2col">
                    <div class="widget"><div class="widget-header"><h2>Number of Ready Nodes</h2></div><div class="widget-content chart-widget-content"><canvas id="numReadyNodesChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Nodes Error Condition</h2></div><div class="widget-content chart-widget-content"><canvas id="nodesErrorConditionChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Running Pods per Node</h2></div><div class="widget-content chart-widget-content"><canvas id="runningPodsPerNodeChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Allocatable Pods on Nodes Utilization</h2></div><div class="widget-content chart-widget-content"><canvas id="allocatablePodsUtilizationChart"></canvas></div></div>
                </div>

                <h3 class="section-title">Node Performance</h3>
                <div class="metrics-grid-2col">
                    <div class="widget"><div class="widget-header"><h2>Node CPU Utilization (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="nodeCpuChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Node Memory Utilization (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="nodeMemoryChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Node Network Total Bytes (Bytes/s)</h2></div><div class="widget-content chart-widget-content"><canvas id="nodeNetworkChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Node Filesystem Utilization (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="nodeFsChart"></canvas></div></div>
                </div>

                <h3 class="section-title">Pod Performance and Limits</h3>
                 <div class="metrics-grid-2col">
                    <div class="widget"><div class="widget-header"><h2>Pod CPU Utilization (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="podCpuChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Pod Memory Utilization (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="podMemoryChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Pod CPU Utilization over Pod Limit (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="podCpuOverPodLimitChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Pod Memory Utilization over Pod Limit (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="podMemoryOverPodLimitChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Pod CPU Utilization over Node Limit (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="podCpuOverNodeLimitChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Pod Memory Utilization over Node Limit (%)</h2></div><div class="widget-content chart-widget-content"><canvas id="podMemoryOverNodeLimitChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Pod Status</h2></div><div class="widget-content chart-widget-content"><canvas id="podStatusChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>Pod Network (Bytes/s)</h2></div><div class="widget-content chart-widget-content"><canvas id="podNetworkChart"></canvas></div></div>
                </div>
                
                <h3 class="section-title">Control Plane</h3>
                <div class="metrics-grid-2col">
                    <div class="widget"><div class="widget-header"><h2>API Server Requests</h2></div><div class="widget-content chart-widget-content"><canvas id="apiServerRequestsChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>REST Client Requests</h2></div><div class="widget-content chart-widget-content"><canvas id="restClientRequestsChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>API Server Admission / ETCD Duration</h2></div><div class="widget-content chart-widget-content"><canvas id="admissionEtcdDurationChart"></canvas></div></div>
                    <div class="widget"><div class="widget-header"><h2>API Server Storage</h2></div><div class="widget-content chart-widget-content"><canvas id="apiServerStorageChart"></canvas></div></div>
                </div>
            </div>
        </div>
        
        <!-- Analysis & Insights Tab -->
        <div id="insights" class="tab-content">
            <div class="widget">
                <div class="widget-header"><h2><i data-feather="shield"></i> Security Best Practices</h2></div>
                <div class="widget-content" style="padding:0;">
                    {% if cluster.security_insights %}
                    <div class="table-container">
                        <table class="data-table security-table">
                             <thead><tr><th>Check</th><th>Status</th><th>Details</th></tr></thead>
                             <tbody>
                                {% for key, insight in cluster.security_insights.items() if key != 'logging_enabled' %}
                                <tr>
                                    <td>{{ insight.description }}</td>
                                    <td style="text-align: center;"><span class="status-badge status-{{ 'active' if insight.status else 'failed' }}">{{ 'Passing' if insight.status else 'Attention' }}</span></td>
                                    <td class="text-secondary">
                                        {% if key == 'latest_platform_version' and not insight.status %}Current: {{ insight.current }}, Latest: {{ insight.latest }}{% else %}-{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                             </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted" style="text-align:center; padding: 2rem;">Security insights could not be generated for this cluster.</p>
                    {% endif %}
                </div>
            </div>

            <div class="widget">
                <div class="widget-header"><h2><i data-feather="align-left"></i> Control Plane Logging</h2></div>
                <div class="widget-content">
                    {% if cluster.security_insights and cluster.security_insights.logging_enabled %}
                        {% set logging_info = cluster.security_insights.logging_enabled %}
                        <ul class="log-status-list">
                        {% for log_type in logging_info.all_logs %}
                            <li class="log-status-item">
                                <span class="log-name">{{ log_type | title }}</span>
                                {% if log_type in logging_info.enabled_logs %}
                                    <span class="status-badge status-active">Enabled</span>
                                {% else %}
                                    <span class="status-badge status-failed">Disabled</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                    <p class="text-muted" style="text-align:center;">Logging status information is not available.</p>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
    {% endif %}
{% endblock %}

{% block scripts_extra %}
<script>
    // --- START: GLOBAL SCOPE ---
    const CLUSTER_INFO = {
        accountId: '{{ cluster.account_id }}',
        region: '{{ cluster.region }}',
        name: '{{ cluster.name }}'
    };
    const workloadsData = {{ cluster.workloads | tojson | safe if cluster.workloads else 'null' }};
    
    // --- Page State Variables ---
    let workloadGraphRendered = false;
    let visNetwork, visNodes, visEdges;
    let activeTab = 'overview';
    let metricCharts = {};
    let metricsLoaded = false;
    let originalNodeStyles = {};

    // --- Tab Switching Logic ---
    function openTab(evt, tabName) {
        activeTab = tabName;
        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
        document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
        document.getElementById(tabName).style.display = 'block';
        evt.currentTarget.classList.add('active');

        if (tabName === 'workloads' && !workloadGraphRendered) {
            renderWorkloadGraph();
            setupPodFilters();
            workloadGraphRendered = true;
        } else if (tabName === 'observability' && !metricsLoaded) {
            loadMetrics();
        }
        feather.replace();
    }
    
    // --- Workload Graph ---
    function renderWorkloadGraph() {
        const container = document.getElementById('workload-graph');
        if (!workloadsData || workloadsData.error || !workloadsData.map_nodes) {
            container.innerHTML = '<p class="text-muted" style="text-align:center; padding: 50px;">Could not render workload graph. Data is unavailable.</p>';
            return;
        }
        const nodes = workloadsData.map_nodes.map(n => {
            originalNodeStyles[n.id] = { group: n.group };
            return n;
        });
        visNodes = new vis.DataSet(nodes);
        visEdges = new vis.DataSet(workloadsData.map_edges);
        const data = { nodes: visNodes, edges: visEdges };
        const options = {
            nodes: { shape: 'dot', size: 18, font: { size: 14, color: 'var(--text-secondary)' }, borderWidth: 2, },
            edges: { width: 1.5, color: { color: 'var(--border-color)', highlight: 'var(--primary-color)', hover: 'var(--primary-color-dark)' }, smooth: { type: 'cubicBezier' }, arrows: { to: { enabled: true, scaleFactor: 0.7 } } },
            groups: {
                ingress: { color: { background: '#FD7E14', border: '#ffc799' }, shape: 'diamond' },
                svc: { color: { background: '#0D6EFD', border: '#a3c7fe' }, shape: 'square' },
                pod: { color: { background: '#198754', border: '#b3d8c6' }, shape: 'dot' },
                node: { color: { background: '#6C757D', border: '#cfd2d4' }, shape: 'triangle', icon: { face: 'Feather', code: '\uf1b2', size: 50, color: 'white' } },
            },
            physics: {
                solver: 'forceAtlas2Based',
                forceAtlas2Based: { gravitationalConstant: -45, centralGravity: 0.01, springLength: 280, springConstant: 0.15, avoidOverlap: 0.8 },
                maxVelocity: 140, minVelocity: 0.75,
                stabilization: { iterations: 200, fit: true },
            },
            interaction: {
                dragNodes: true, dragView: true, hover: true, zoomView: true, tooltipDelay: 200, hideEdgesOnDrag: true,
                navigationButtons: true, keyboard: { enabled: true, speed: { x: 10, y: 10, zoom: 0.02 }, bindToWindow: true }
            },
            layout: { improvedLayout: true }
        };
        visNetwork = new vis.Network(container, data, options);
        setupGraphInteractions();
    }
    
    function setupGraphInteractions() {
        const infoPanel = document.getElementById('graph-info-panel');
        const searchInput = document.getElementById('graph-search');
        visNetwork.on('click', (properties) => {
            if (properties.nodes.length > 0) {
                const nodeId = properties.nodes[0];
                const nodeData = visNodes.get(nodeId);
                populateInfoPanel(nodeData.details);
                highlightNodeAndConnections(nodeId);
            } else {
                resetHighlightAndPanel();
            }
        });
        document.getElementById('graph-info-close').addEventListener('click', resetHighlightAndPanel);
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) {
                resetHighlightAndPanel();
                return;
            }
            const foundNode = workloadsData.map_nodes.find(n => n.label.toLowerCase().includes(searchTerm));
            if (foundNode) {
                visNetwork.focus(foundNode.id, { scale: 1.2, animation: true });
                populateInfoPanel(foundNode.details);
                highlightNodeAndConnections(foundNode.id);
            }
        });
    }

    function populateInfoPanel(details) {
        const panel = document.getElementById('graph-info-panel');
        const titleEl = document.getElementById('info-panel-title');
        const bodyEl = document.getElementById('info-panel-body');
        titleEl.textContent = `${details.kind}: ${details.name}`;
        let html = '';
        for (const [key, value] of Object.entries(details)) {
            if (key === 'kind' || key === 'name') continue;
            let displayValue;
            if (Array.isArray(value)) {
                displayValue = value.length > 0 ? `<ul>${value.map(item => `<li><span class="code">${JSON.stringify(item)}</span></li>`).join('')}</ul>` : 'None';
            } else if (typeof value === 'object' && value !== null) {
                displayValue = `<pre class="code" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${JSON.stringify(value, null, 2)}</pre>`;
            } else {
                displayValue = `<span class="code">${value || 'N/A'}</span>`;
            }
            const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<strong>${displayKey}</strong><div>${displayValue}</div>`;
        }
        bodyEl.innerHTML = html;
        panel.classList.add('visible');
    }

    function highlightNodeAndConnections(nodeId) {
        const allNodes = visNodes.get({ returnType: 'Object' });
        const connectedNodes = visNetwork.getConnectedNodes(nodeId);
        connectedNodes.push(nodeId);
        const nodesToUpdate = [];
        for (const id in allNodes) {
            const node = allNodes[id];
            if (!connectedNodes.includes(id)) {
                node.color = { border: 'rgba(200, 200, 200, 0.2)', background: 'rgba(240, 240, 240, 0.2)' };
                node.font = { color: 'rgba(200, 200, 200, 0.5)' };
                node.label = undefined;
            } else {
                 node.color = null;
                 node.font = { color: 'var(--text-secondary)' };
                 node.label = workloadsData.map_nodes.find(n => n.id === id).label;
            }
            nodesToUpdate.push(node);
        }
        visNodes.update(nodesToUpdate);
    }
    
    function resetHighlightAndPanel() {
        document.getElementById('graph-info-panel').classList.remove('visible');
        const nodesToUpdate = visNodes.get().map(node => ({ id: node.id, color: null, font: { color: 'var(--text-secondary)' }, label: workloadsData.map_nodes.find(n => n.id === node.id).label }));
        visNodes.update(nodesToUpdate);
        document.getElementById('graph-search').value = '';
        visNetwork.fit();
    }
    
    // --- Pod Filtering ---
    function setupPodFilters() {
        if (!workloadsData || !workloadsData.pods) return;
        const namespaceSelect = document.getElementById('pod-namespace-filter');
        const uniqueNamespaces = [...new Set(workloadsData.pods.map(p => p.metadata.namespace))].sort();
        namespaceSelect.innerHTML = '<option value="all">All Namespaces</option>' + uniqueNamespaces.map(ns => `<option value="${ns}">${ns}</option>`).join('');
        const nameFilter = document.getElementById('pod-name-filter');
        const statusFilter = document.getElementById('pod-status-filter');
        const applyFilters = () => {
            const name = nameFilter.value.toLowerCase();
            const namespace = namespaceSelect.value;
            const status = statusFilter.value;
            const podRows = document.querySelectorAll('#all-pods-table tbody tr');
            podRows.forEach(row => {
                const rowName = row.dataset.name, rowNamespace = row.dataset.namespace, rowStatus = row.dataset.status;
                const nameMatch = rowName.includes(name);
                const namespaceMatch = (namespace === 'all' || rowNamespace === namespace);
                const statusMatch = (status === 'all' || rowStatus === status);
                row.style.display = (nameMatch && namespaceMatch && statusMatch) ? '' : 'none';
            });
        };
        [nameFilter, namespaceSelect, statusFilter].forEach(el => el.addEventListener('change', applyFilters));
        nameFilter.addEventListener('input', applyFilters);
    }

    // --- Metrics and Charting Functions ---
    function getChartBaseOptions(y1Title = '', y2Title = '') {
        const computedStyle = getComputedStyle(document.documentElement);
        const textSecondary = computedStyle.getPropertyValue('--text-secondary').trim();
        const textPrimary = computedStyle.getPropertyValue('--text-primary').trim();
        const borderColor = computedStyle.getPropertyValue('--border-color').trim();
        const surfaceColor = computedStyle.getPropertyValue('--surface-color').trim();

        const options = {
            responsive: true, maintainAspectRatio: false,
            scales: {
                x: { type: 'time', time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }}, ticks: { color: textSecondary }, grid: { color: borderColor }},
                y1: { type: 'linear', position: 'left', beginAtZero: true, ticks: { color: textSecondary }, grid: { color: borderColor }, title: { display: !!y1Title, text: y1Title, color: textSecondary } }
            },
            plugins: { 
                legend: { position: 'bottom', labels: { color: textSecondary, usePointStyle: true, boxHeight: 8, padding: 20 } },
                tooltip: {
                    mode: 'index', intersect: false, backgroundColor: surfaceColor, titleColor: textSecondary, bodyColor: textPrimary,
                    bodyFont: { weight: 'bold' }, borderColor: borderColor, borderWidth: 1, padding: 12, cornerRadius: 6,
                    callbacks: { label: (context) => `${context.dataset.label || ''}: ${context.parsed.y !== null ? context.parsed.y.toFixed(context.dataset.yAxisID === 'y2' ? 5 : 2) : 'N/A'}` }
                }
            },
            interaction: { mode: 'index', intersect: false },
            elements: { point: { radius: 0, hoverRadius: 5 }, line: { tension: 0.2, borderWidth: 2 } }
        };

        if (y2Title) {
            options.scales.y2 = { type: 'linear', position: 'right', beginAtZero: true, ticks: { color: textSecondary }, grid: { drawOnChartArea: false }, title: { display: true, text: y2Title, color: textSecondary } };
        }
        return options;
    }

    function renderDualAxisChart(canvasId, datasets, y1Title, y2Title) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
        if (metricCharts[canvasId]) metricCharts[canvasId].destroy();
        
        const colors = { y1: ['#0d6efd', '#198754'], y2: ['#fd7e14', '#6f42c1'] };
        let y1_idx = 0;
        let y2_idx = 0;

        const chartDatasets = datasets.map(ds => {
            const isY2 = ds.yAxisID === 'y2';
            const color = isY2 ? colors.y2[y2_idx++] : colors.y1[y1_idx++];
            return {
                label: ds.label,
                data: ds.timestamps.map((ts, i) => ({ x: new Date(ts), y: ds.values[i] })),
                borderColor: ds.color || color,
                backgroundColor: 'transparent',
                yAxisID: isY2 ? 'y2' : 'y1',
                fill: false,
                type: ds.type || 'line', // Allow bar type
                borderWidth: ds.type === 'bar' ? 0 : 2
            }
        });

        metricCharts[canvasId] = new Chart(ctx, { data: { datasets: chartDatasets }, options: getChartBaseOptions(y1Title, y2Title) });
    }

    function renderChart(canvasId, datasets, stacked = false, yAxisTitle = '') {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
        if (metricCharts[canvasId]) metricCharts[canvasId].destroy();
        const colors = ['#0d6efd', '#fd7e14', '#198754', '#ffc107', '#6f42c1', '#dc3545', '#0dcaf0'];
        
        const chartOptions = getChartBaseOptions(yAxisTitle);
        chartOptions.scales.y1.stacked = stacked;

        metricCharts[canvasId] = new Chart(ctx, { type: 'line', data: {
            datasets: datasets.map((ds, index) => ({
                label: ds.label,
                data: ds.timestamps.map((ts, i) => ({ x: new Date(ts), y: ds.values[i] })),
                borderColor: ds.color || colors[index % colors.length], 
                backgroundColor: ds.bgColor || (stacked ? (ds.color || colors[index % colors.length]) + '80' : 'transparent'),
                fill: stacked,
                yAxisID: 'y1',
                type: ds.type || 'line',
                borderWidth: ds.type === 'bar' ? 0 : 2
            }))
        }, options: chartOptions });
    }
    
    function renderOrShowNoData(canvasId, renderFn) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const container = canvas.parentElement;
        const noDataMessage = container.querySelector('.no-data-message');
        if (noDataMessage) noDataMessage.remove();
        canvas.style.display = 'block';

        const hasData = renderFn(); // Let the specific render function decide if it has data
        if (!hasData) {
            canvas.style.display = 'none';
            const messageDiv = document.createElement('div');
            messageDiv.className = 'no-data-message';
            messageDiv.innerHTML = `<p><strong>No data available</strong></p><p class="text-muted" style="font-size:0.8rem;">Ensure required metrics are enabled in Container Insights.</p>`;
            container.appendChild(messageDiv);
        }
    }

    function processAndRenderCharts(metrics) {
        const hasData = (key) => metrics[key] && metrics[key].values && metrics[key].values.length > 0;
        const colors = { avg: '#0d6efd', max: '#fd7e14' }; // avg: blue, max: orange

        // --- Cluster Health ---
        renderOrShowNoData('nodeStatusChart', () => {
            const datasets = [];
            if (hasData('cluster_node_count')) {
                const total = metrics.cluster_node_count;
                const failed = hasData('cluster_failed_node_count') ? metrics.cluster_failed_node_count : { timestamps: total.timestamps, values: total.values.map(() => 0) };
                const readyTimestamps = total.timestamps;
                const readyValues = total.values.map((t, i) => t - (failed.values[i] || 0));
                datasets.push({ timestamps: readyTimestamps, values: readyValues, label: 'Ready', color: '#198754' });
                if (hasData('cluster_failed_node_count')) datasets.push({ ...failed, label: 'Not Ready', color: '#DC3545' });
            }
            if(datasets.length > 0) renderChart('nodeStatusChart', datasets, true, 'Node Count');
            return datasets.length > 0;
        });
        
        renderOrShowNoData('containerRestartsChart', () => {
            const datasets = hasData('container_restarts') ? [ {...metrics.container_restarts, label: 'Restarts', color: '#FFC107' } ] : [];
            if (datasets.length > 0) renderChart('containerRestartsChart', datasets, false, 'Count');
            return datasets.length > 0;
        });
        
        // --- Nodes Status & Capacity ---
        renderOrShowNoData('numReadyNodesChart', () => { const ds = hasData('node_status_condition_ready') ? [ {...metrics.node_status_condition_ready, label: 'Ready Nodes', color: '#198754'} ] : []; if(ds.length > 0) renderChart('numReadyNodesChart', ds, false, 'Count'); return ds.length > 0; });
        renderOrShowNoData('nodesErrorConditionChart', () => {
            const ds = [];
            if (hasData('node_status_condition_out_of_disk')) ds.push({...metrics.node_status_condition_out_of_disk, label: 'Out of Disk', color: '#fd7e14'});
            if (hasData('node_status_condition_memory_pressure')) ds.push({...metrics.node_status_condition_memory_pressure, label: 'Memory Pressure', color: '#dc3545'});
            if (hasData('node_status_condition_pid_pressure')) ds.push({...metrics.node_status_condition_pid_pressure, label: 'PID Pressure', color: '#6f42c1'});
            if(ds.length > 0) renderChart('nodesErrorConditionChart', ds, true, 'Count'); return ds.length > 0;
        });
        renderOrShowNoData('runningPodsPerNodeChart', () => { const ds = hasData('node_number_of_running_pods') ? [ {...metrics.node_number_of_running_pods, label: 'Avg Running Pods', color: '#0d6efd'} ] : []; if(ds.length > 0) renderChart('runningPodsPerNodeChart', ds, false, 'Count'); return ds.length > 0; });
        renderOrShowNoData('allocatablePodsUtilizationChart', () => { const ds = hasData('node_allocatable_pods_utilization') ? [ {...metrics.node_allocatable_pods_utilization, label: 'avg: node_allocatable_pods_utilization', color: '#0dcaf0'} ] : []; if(ds.length > 0) renderChart('allocatablePodsUtilizationChart', ds, false, 'Count'); return ds.length > 0; });

        // --- Node Performance ---
        renderOrShowNoData('nodeCpuChart', () => {
            const datasets = [];
            if (hasData('node_cpu_utilization_avg')) datasets.push({...metrics.node_cpu_utilization_avg, label: 'avg: node_cpu_utilization', color: colors.avg});
            if (hasData('node_cpu_utilization_max')) datasets.push({...metrics.node_cpu_utilization_max, label: 'max: node_cpu_utilization', color: colors.max});
            if (datasets.length > 0) renderChart('nodeCpuChart', datasets, false, '%');
            return datasets.length > 0;
        });
        renderOrShowNoData('nodeMemoryChart', () => {
            const datasets = [];
            if (hasData('node_memory_utilization_avg')) datasets.push({...metrics.node_memory_utilization_avg, label: 'avg: node_memory_utilization', color: colors.avg});
            if (hasData('node_memory_utilization_max')) datasets.push({...metrics.node_memory_utilization_max, label: 'max: node_memory_utilization', color: colors.max});
            if (datasets.length > 0) renderChart('nodeMemoryChart', datasets, false, '%');
            return datasets.length > 0;
        });
        renderOrShowNoData('nodeFsChart', () => { const ds = hasData('node_filesystem_utilization') ? [{...metrics.node_filesystem_utilization, label: 'Filesystem %', color: '#198754'}] : []; if (ds.length > 0) renderChart('nodeFsChart', ds, false, '%'); return ds.length > 0; });
        renderOrShowNoData('nodeNetworkChart', () => {
            const datasets = [];
            if (hasData('node_network_total_bytes_max')) datasets.push({...metrics.node_network_total_bytes_max, label: 'max: node_network_total_bytes', color: '#fd7e14', bgColor: '#fd7e1440', type: 'bar'});
            if (hasData('node_network_total_bytes_avg')) datasets.push({...metrics.node_network_total_bytes_avg, label: 'avg: node_network_total_bytes', color: '#0dcaf0', type: 'line'});
            if (datasets.length > 0) renderChart('nodeNetworkChart', datasets, false, 'Bytes/Second');
            return datasets.length > 0;
        });
        
        // --- Pod Performance and Limits ---
        renderOrShowNoData('podCpuChart', () => {
            const datasets = [];
            if (hasData('pod_cpu_utilization_avg')) datasets.push({...metrics.pod_cpu_utilization_avg, label: 'avg: pod_cpu_utilization', color: colors.avg});
            if (hasData('pod_cpu_utilization_max')) datasets.push({...metrics.pod_cpu_utilization_max, label: 'max: pod_cpu_utilization', color: colors.max});
            if (datasets.length > 0) renderChart('podCpuChart', datasets, false, '%');
            return datasets.length > 0;
        });
        renderOrShowNoData('podMemoryChart', () => {
            const datasets = [];
            if (hasData('pod_memory_utilization_avg')) datasets.push({...metrics.pod_memory_utilization_avg, label: 'avg: pod_memory_utilization', color: colors.avg});
            if (hasData('pod_memory_utilization_max')) datasets.push({...metrics.pod_memory_utilization_max, label: 'max: pod_memory_utilization', color: colors.max});
            if (datasets.length > 0) renderChart('podMemoryChart', datasets, false, '%');
            return datasets.length > 0;
        });
        renderOrShowNoData('podCpuOverPodLimitChart', () => {
            const datasets = [];
            if (hasData('pod_cpu_utilization_over_pod_limit_avg')) datasets.push({...metrics.pod_cpu_utilization_over_pod_limit_avg, label: 'avg: pod_cpu_utilization_over_pod_limit', color: colors.avg});
            if (hasData('pod_cpu_utilization_over_pod_limit_max')) datasets.push({...metrics.pod_cpu_utilization_over_pod_limit_max, label: 'max: pod_cpu_utilization_over_pod_limit', color: colors.max});
            if (datasets.length > 0) renderChart('podCpuOverPodLimitChart', datasets, false, '%');
            return datasets.length > 0;
        });
        renderOrShowNoData('podMemoryOverPodLimitChart', () => {
            const datasets = [];
            if (hasData('pod_memory_utilization_over_pod_limit_avg')) datasets.push({...metrics.pod_memory_utilization_over_pod_limit_avg, label: 'avg: pod_memory_utilization_over_pod_limit', color: colors.avg});
            if (hasData('pod_memory_utilization_over_pod_limit_max')) datasets.push({...metrics.pod_memory_utilization_over_pod_limit_max, label: 'max: pod_memory_utilization_over_pod_limit', color: colors.max});
            if (datasets.length > 0) renderChart('podMemoryOverPodLimitChart', datasets, false, '%');
            return datasets.length > 0;
        });
        renderOrShowNoData('podCpuOverNodeLimitChart', () => {
            const datasets = [];
            if (hasData('pod_cpu_utilization_avg')) datasets.push({...metrics.pod_cpu_utilization_avg, label: 'avg: pod_cpu_utilization', color: colors.avg});
            if (hasData('pod_cpu_utilization_max')) datasets.push({...metrics.pod_cpu_utilization_max, label: 'max: pod_cpu_utilization', color: colors.max});
            if (datasets.length > 0) renderChart('podCpuOverNodeLimitChart', datasets, false, '%');
            return datasets.length > 0;
        });
        renderOrShowNoData('podMemoryOverNodeLimitChart', () => {
            const datasets = [];
            if (hasData('pod_memory_utilization_avg')) datasets.push({...metrics.pod_memory_utilization_avg, label: 'avg: pod_memory_utilization', color: colors.avg});
            if (hasData('pod_memory_utilization_max')) datasets.push({...metrics.pod_memory_utilization_max, label: 'max: pod_memory_utilization', color: colors.max});
            if (datasets.length > 0) renderChart('podMemoryOverNodeLimitChart', datasets, false, '%');
            return datasets.length > 0;
        });
        renderOrShowNoData('podNetworkChart', () => {
            const ds = [];
            if (hasData('pod_network_rx_bytes')) ds.push({...metrics.pod_network_rx_bytes, label: 'Received', color: '#0dcaf0'});
            if (hasData('pod_network_tx_bytes')) ds.push({...metrics.pod_network_tx_bytes, label: 'Transmitted', color: '#fd7e14'});
            if(ds.length>0) renderChart('podNetworkChart', ds, false, 'Bytes/s'); return ds.length > 0;
        });
        renderOrShowNoData('podStatusChart', () => {
            const ds = [];
            if (hasData('pod_status_running')) ds.push({...metrics.pod_status_running, label: 'Running', color: '#198754'});
            if (hasData('pod_status_pending')) ds.push({...metrics.pod_status_pending, label: 'Pending', color: '#FFC107'});
            if (hasData('pod_status_succeeded')) ds.push({...metrics.pod_status_succeeded, label: 'Succeeded', color: '#0DCAF0'});
            if (hasData('pod_status_failed')) ds.push({...metrics.pod_status_failed, label: 'Failed', color: '#DC3545'});
            if (hasData('pod_status_unknown')) ds.push({...metrics.pod_status_unknown, label: 'Unknown', color: '#6C757D'});
            if(ds.length > 0) renderChart('podStatusChart', ds, true, 'Count'); return ds.length > 0;
        });
        
        // --- Control Plane ---
        renderOrShowNoData('apiServerRequestsChart', () => {
            const ds = [];
            if (hasData('apiserver_request_total')) ds.push({...metrics.apiserver_request_total, label: 'request_total', yAxisID: 'y1', color: '#0d6efd'});
            if (hasData('apiserver_request_duration_seconds')) ds.push({...metrics.apiserver_request_duration_seconds, label: 'request_duration_seconds', yAxisID: 'y2', color: '#fd7e14'});
            if(ds.length > 0) renderDualAxisChart('apiServerRequestsChart', ds, 'Count', 'Seconds'); return ds.length > 0;
        });
        renderOrShowNoData('restClientRequestsChart', () => {
            const ds = [];
            if (hasData('rest_client_requests_total')) ds.push({...metrics.rest_client_requests_total, label: 'requests_total', yAxisID: 'y1', color: '#0d6efd'});
            if (hasData('rest_client_request_duration_seconds')) ds.push({...metrics.rest_client_request_duration_seconds, label: 'request_duration_seconds', yAxisID: 'y2', color: '#fd7e14'});
            if(ds.length > 0) renderDualAxisChart('restClientRequestsChart', ds, 'Count', 'Seconds'); return ds.length > 0;
        });
        renderOrShowNoData('admissionEtcdDurationChart', () => {
            const ds = [];
            if (hasData('apiserver_admission_controller_admission_duration_seconds')) ds.push({...metrics.apiserver_admission_controller_admission_duration_seconds, label: 'admission_controller_duration', color: '#0d6efd'});
            if (hasData('etcd_request_duration_seconds')) ds.push({...metrics.etcd_request_duration_seconds, label: 'etcd_request_duration', color: '#fd7e14'});
            if(ds.length > 0) renderChart('admissionEtcdDurationChart', ds, false, 'Seconds'); return ds.length > 0;
        });
        renderOrShowNoData('apiServerStorageChart', () => {
            const ds = [];
            if (hasData('apiserver_storage_objects')) ds.push({...metrics.apiserver_storage_objects, label: 'storage_objects', yAxisID: 'y1', color: '#0d6efd'});
            if (hasData('apiserver_storage_size_bytes')) ds.push({...metrics.apiserver_storage_size_bytes, label: 'storage_size_bytes', yAxisID: 'y2', color: '#fd7e14'});
            if(ds.length > 0) renderDualAxisChart('apiServerStorageChart', ds, 'Count', 'Bytes'); return ds.length > 0;
        });
    }
    
    async function loadMetrics() {
        if (metricsLoaded) return;
        const loadingState = document.getElementById('metrics-loading-state');
        const grid = document.querySelector('.metrics-container');
        const errorState = document.getElementById('metrics-error-state');
        loadingState.style.display = 'block';
        grid.style.display = 'none';
        errorState.style.display = 'none';
        try {
            const url = `/api/metrics/${CLUSTER_INFO.accountId}/${CLUSTER_INFO.region}/${CLUSTER_INFO.name}`;
            const response = await fetch(url);
            const metricsData = await response.json();
            if (!response.ok) throw new Error(metricsData.error || 'Failed to fetch metrics');
            if (Object.keys(metricsData).length === 0 || Object.values(metricsData).every(d => !d || d.values.length === 0)) {
                throw new Error("No metrics data returned. Ensure Container Insights and Control Plane metrics are enabled for this cluster and have had time to collect data.");
            }
            processAndRenderCharts(metricsData);
            metricsLoaded = true;
            grid.style.display = 'block';
        } catch (error) {
            errorState.querySelector('p').textContent = `Error: ${error.message}`;
            errorState.style.display = 'block';
        } finally {
            loadingState.style.display = 'none';
        }
    }
    
    // --- DOMContentLoaded Event Listener ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('overview').style.display = 'block';
        feather.replace();
        
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async () => {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i data-feather="loader" class="spin"></i> Refreshing...';
                feather.replace();
                try {
                    const url = `/api/refresh-cluster/${CLUSTER_INFO.accountId}/${CLUSTER_INFO.region}/${CLUSTER_INFO.name}`;
                    const response = await fetch(url, { method: 'POST' });
                    if (response.ok) { window.location.reload(); }
                    else {
                        const result = await response.json();
                        alert('Failed to refresh data: ' + (result.error || 'Unknown error'));
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i data-feather="refresh-cw"></i> Refresh Data';
                        feather.replace();
                    }
                } catch (error) {
                    alert('An error occurred while trying to refresh data.');
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i data-feather="refresh-cw"></i> Refresh Data';
                    feather.replace();
                }
            });
        }

        document.querySelectorAll('.upgrade-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                if (!confirm(`Are you sure you want to upgrade nodegroup "${btn.dataset.nodegroupName}"?`)) return;
                btn.disabled = true;
                btn.innerHTML = '<i data-feather="loader" class="spin"></i> Upgrading...';
                feather.replace();
                const response = await fetch('/api/upgrade-nodegroup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountId: CLUSTER_INFO.accountId, region: CLUSTER_INFO.region, clusterName: CLUSTER_INFO.name, nodegroupName: btn.dataset.nodegroupName, }),
                });
                const result = await response.json();
                if (response.ok) {
                    alert(`Upgrade initiated successfully!`);
                    window.location.reload();
                } else {
                    alert(`Upgrade failed: ${result.error}`);
                    btn.disabled = false;
                }
            });
        });
    });
</script>
{% endblock %}
